<section class="flex h-full flex-col gap-6 p-6" (click)="closeTaskDetails()">
  <header class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold text-slate-900">Calendario</h1>
      <p class="mt-1 text-sm text-slate-600">
        Visualiza los vencimientos de tus tareas asignadas.
      </p>
    </div>

    <div class="flex items-center gap-4 rounded-lg border border-slate-200 bg-white p-1 shadow-sm">
      <button (click)="changeMonth(-1); $event.stopPropagation()"
              class="rounded-md p-2 text-slate-500 hover:bg-slate-100 hover:text-slate-900">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5">
          <path fill-rule="evenodd" d="M11.78 5.22a.75.75 0 0 1 0 1.06L8.06 10l3.72 3.72a.75.75 0 1 1-1.06 1.06l-4.25-4.25a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" />
        </svg>
      </button>

      <span class="min-w-[140px] text-center text-base font-semibold text-slate-900">
        {{ viewDate | date:'MMMM yyyy' | titlecase }}
      </span>

      <button (click)="changeMonth(1); $event.stopPropagation()"
              class="rounded-md p-2 text-slate-500 hover:bg-slate-100 hover:text-slate-900">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5">
          <path fill-rule="evenodd" d="M8.22 5.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06-1.06L11.94 10 8.22 6.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
        </svg>
      </button>
    </div>
  </header>

  <div class="flex flex-1 flex-col rounded-xl border border-slate-200 bg-white shadow-sm overflow-visible">
    <div class="grid grid-cols-7 border-b border-slate-200 bg-slate-50">
      @for (day of weekDays; track day) {
        <div class="py-4 text-center text-xs font-bold uppercase tracking-wider text-slate-500">
          {{ day }}
        </div>
      }
    </div>

    <div class="flex-1 grid grid-cols-7 grid-rows-6">
      @for (cell of calendarGrid; track $index) {
        <div class="relative min-h-[120px] border-b border-r border-slate-100 p-2 transition-colors hover:bg-slate-50/50"
             [ngClass]="{
               'bg-slate-50/30': !cell.isCurrentMonth,
               'bg-white': cell.isCurrentMonth
             }">

          <span class="block text-sm font-medium mb-2"
                [ngClass]="{
                  'text-[#427A76] font-bold': cell.isToday,
                  'text-slate-700': !cell.isToday && cell.isCurrentMonth,
                  'text-slate-300': !cell.isCurrentMonth
                }">
            {{ cell.date | date:'d' }}
          </span>

          <div class="flex flex-wrap gap-1">
            @for (task of cell.tasks; track task.id) {
              <button (click)="openTaskDetails(task, $event)"
                      class="h-6 w-6 rounded-full bg-amber-100 border border-amber-200 text-amber-700 text-xs font-bold flex items-center justify-center transition hover:scale-110 hover:bg-amber-200 hover:shadow-sm"
                      title="Ver tarea">
                !
              </button>

              @if (activeTask?.id === task.id) {
                <div class="absolute left-1/2 bottom-full mb-2 -translate-x-1/2 z-50 w-64 rounded-xl bg-white p-4 shadow-xl border border-slate-200 ring-1 ring-slate-900/5"
                     (click)="$event.stopPropagation()">

                  <div class="absolute -bottom-2 left-1/2 -translate-x-1/2 w-4 h-4 bg-white border-b border-r border-slate-200 rotate-45"></div>

                  <div class="relative z-10">
                    <div class="flex justify-between items-start mb-2">
                      <span class="text-[10px] font-bold uppercase tracking-wider text-[#427A76]">Vence: {{task.dueOn?.slice(0,10)}}</span>
                      <button (click)="closeTaskDetails()" class="text-slate-400 hover:text-slate-600">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path d="M6.28 5.22a.75.75 0 0 0-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 1 0 1.06 1.06L10 11.06l3.72 3.72a.75.75 0 1 0 1.06-1.06L11.06 10l3.72-3.72a.75.75 0 0 0-1.06-1.06L10 8.94 6.28 5.22Z" /></svg>
                      </button>
                    </div>

                    <h4 class="font-bold text-slate-900 text-sm mb-1">{{ task.title }}</h4>

                    @if (task.description) {
                      <p class="text-xs text-slate-500 line-clamp-2 mb-3">{{ task.description }}</p>
                    } @else {
                      <p class="text-xs text-slate-400 italic mb-3">Sin descripci√≥n</p>
                    }

                    <div class="flex items-center justify-between pt-2 border-t border-slate-100">
                      <span class="text-xs text-slate-500">Estado:
                        <span class="font-medium text-slate-700">{{ task.status }}</span>
                      </span>
                    </div>
                  </div>
                </div>
              }
            }
          </div>
        </div>
      }
    </div>
  </div>
</section>
