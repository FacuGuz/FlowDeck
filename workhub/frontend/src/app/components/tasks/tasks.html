<div class="flex h-full gap-4 py-6 pr-6 pl-2">

  <aside class="w-64 flex-shrink-0 hidden lg:block mr-5">
    <div class="rounded-xl border border-slate-200 bg-white p-5 shadow-sm h-full pr-5 overflow-y-auto">
      <h3 class="text-xs font-semibold uppercase tracking-wider text-slate-500  mb-4">Filtrar por Equipo</h3>

      <ul class="space-y-1">
        @for (option of (teamOptions$ | async) ?? []; track option.team.id) {
          <li>
            <button type="button"
                    (click)="toggleTeamFilter(option.team.id)"
                    class="flex w-full items-center gap-3 rounded-lg px-3 py-2 text-sm font-medium transition-colors text-left"
                    [ngClass]="isTeamSelected(option.team.id)
                      ? 'bg-[#427A76] text-white shadow-sm'
                      : 'text-slate-700 hover:bg-slate-50'">

              <span class="truncate">{{ option.team.name }}</span>

              @if (isTeamSelected(option.team.id)) {
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="ml-auto w-4 h-4">
                  <path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 0 1 .143 1.052l-8 10.5a.75.75 0 0 1-1.127.075l-4.5-4.5a.75.75 0 0 1 1.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 0 1 1.05-.143Z" clip-rule="evenodd" />
                </svg>
              }
            </button>
          </li>
        } @empty {
          <li class="text-xs text-slate-400 italic">No tienes equipos asignados.</li>
        }
      </ul>
    </div>
  </aside>

  <section class="flex flex-1 flex-col gap-5 overflow-y-auto">
    <header class="flex flex-col items-start justify-between gap-4 sm:flex-row sm:items-center">
      <div>
        <h2 class="text-xl font-semibold text-slate-900">Mis Tareas</h2>
        <p class="mt-1 text-sm text-slate-600">Gestiona todas las tareas de tus equipos.</p>
      </div>

      <div class="flex flex-wrap gap-3">
        <button type="button"
                class="group relative overflow-hidden  bg-slate-900 px-6 py-3 text-white transition hover:-translate-y-0.5 hover:shadow-lg disabled:opacity-50"
                (click)="openPanel('task')">
          <span class="relative z-10 text-sm font-semibold">CREAR TAREA</span>
          <div class="absolute inset-0 bg-gradient-to-r from-sky-600 to-indigo-600 opacity-0 transition-opacity group-hover:opacity-20"></div>
        </button>
      </div>
    </header>

    @if (feedback; as fb) {
      <div class="rounded-xl border p-4 text-sm"
           [ngClass]="fb.type === 'success' ? 'border-emerald-200 bg-emerald-50 text-emerald-700' : 'border-rose-200 bg-rose-50 text-rose-700'">
        {{ fb.text }}
      </div>
    }

    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
      @for (task of tareas; track task.id) {
        <div class="flex flex-col bg-white  shadow-lg border border-gray-200 border-t-4 border-t-[#427A76] overflow-hidden transition-shadow duration-200 hover:shadow-xl">
          <div class="p-4 border-b border-gray-200 bg-gray-50">
            <span class="block text-sm font-semibold text-[#427A76]">
              EQUIPO: {{ task.teamName ?? 'Equipo sin nombre' }}
            </span>
            <p class="text-lg font-bold text-gray-900 mt-1">
              {{ task.title }}
            </p>
          </div>
          <div class="p-4 flex-grow space-y-4">
            <div class="space-y-2">
              <p class="text-sm text-gray-600">
                Responsable:
                <span class="font-medium text-gray-800">
                  {{ task.assigneeName ?? 'Sin responsable' }}
                </span>
              </p>
              <p class="text-sm text-gray-600">
                Vence:
                <span class="font-medium text-gray-800">
                  {{ formatDueDate(task.dueOn) }}
                </span>
              </p>
            </div>
            @if (task.checklist.length) {
              <div class="pt-4 border-t border-gray-100 space-y-3">
                <p class="text-xs font-semibold uppercase tracking-wide text-gray-500">Checklist</p>
                <ul class="space-y-2">
                  @for (item of task.checklist; track item.id; let idx = $index) {
                    <li class="flex items-start gap-3 p-2 border rounded-lg"
                        [ngClass]="{
                          'bg-red-200 border-red-300': !item.completed,
                          'bg-green-200 border-green-300': item.completed
                        }">
                      <input type="checkbox"
                             class="mt-1 h-4 w-4 rounded border-gray-300 text-[#427A76] focus:ring-[#427A76] cursor-pointer"
                             [checked]="item.completed"
                             (change)="onChecklistToggle(task, idx)" />
                      <div class="flex-1 space-y-0.5">
                        <span class="text-sm font-medium"
                              [ngClass]="{
                                'text-red-900': !item.completed,
                                'text-green-900': item.completed
                              }">
                          {{ item.title }}
                        </span>
                        @if (item.description) {
                          <p class="text-xs"
                             [ngClass]="{
                                'text-red-700': !item.completed,
                                'text-green-700': item.completed
                              }">
                            {{ item.description }}
                          </p>
                        }
                      </div>
                      @if (item.completed) {
                        <span class="mt-1 text-xs font-semibold px-2 py-0.5  bg-green-300 text-green-900">
                          COMPLETADO
                        </span>
                      }
                    </li>
                  }
                </ul>
              </div>
            }
          </div>
          <div class="p-4 bg-gray-50 border-t border-gray-200 flex items-center justify-between gap-4">
            <span class="text-sm font-semibold uppercase tracking-wide text-gray-600">Estado</span>
            <select
              class="w-auto rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 focus:border-[#427A76] focus:outline-none focus:ring-1 focus:ring-[#427A76] disabled:opacity-60"
              [ngModel]="task.status"
              (ngModelChange)="onStatusChange(task, $event)"
            >
              @for (status of taskStatuses; track status) {
                <option [ngValue]="status">{{ translateStatus(status) }}</option>
              }
            </select>
          </div>
        </div>
      } @empty {
        <div class="col-span-full p-6 text-center text-gray-500 bg-white rounded-lg shadow-md border border-gray-200">
          No se encontraron tareas asignadas
        </div>
      }
    </div>
  </section>
</div>
@if (activePanel === 'task') {
  <div class="fixed inset-0 z-50 flex">
    <div class="absolute inset-0 bg-slate-900/40" (click)="closePanel()"></div>
    <div class="relative ml-auto flex h-full w-full max-w-xl flex-col bg-white shadow-2xl">
      <header class="flex items-center justify-between border-b border-slate-200 px-6 py-4">
        <div>
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Nueva tarea</p>
          <h3 class="text-lg font-semibold text-slate-900">Define los datos b&aacute;sicos</h3>
        </div>
        <button type="button"
                class="rounded-full p-1.5 text-slate-500 hover:bg-slate-100"
                (click)="closePanel()">
          <span class="sr-only">Cerrar panel</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
          </svg>
        </button>
      </header>

      <form class="flex-1 overflow-y-auto px-6 py-5 space-y-5"
            [formGroup]="createTaskForm"
            (ngSubmit)="submitCreateTask()">
        <div class="space-y-2">
          <label class="text-xs font-semibold uppercase tracking-wide text-slate-600">Equipo</label>
          <select formControlName="teamId"
                  class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-[#427A76] focus:outline-none focus:ring-2 focus:ring-[#427A76]">
            <option [ngValue]="null">Selecciona un equipo</option>
            @for (option of (teamOptions$ | async) ?? []; track option.team.id) {
              <option [ngValue]="option.team.id">{{ option.team.name }}</option>
            }
          </select>
        </div>

        <div class="space-y-2">
          <label class="text-xs font-semibold uppercase tracking-wide text-slate-600">T&iacute;tulo</label>
          <input type="text"
                 formControlName="title"
                 class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-[#427A76] focus:outline-none focus:ring-2 focus:ring-[#427A76]"
                 placeholder="Ej: Actualizar roadmap del Q1" />
        </div>

        <div class="space-y-2">
          <label class="text-xs font-semibold uppercase tracking-wide text-slate-600">Descripci&oacute;n</label>
          <textarea formControlName="description"
                    rows="4"
                    class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-[#427A76] focus:outline-none focus:ring-2 focus:ring-[#427A76]"
                    placeholder="Describe el objetivo y el alcance de la tarea"></textarea>
        </div>

        <div class="grid gap-4 sm:grid-cols-2">
          <div class="space-y-2">
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-600">Estado inicial</label>
            <select formControlName="status"
                    class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-[#427A76] focus:outline-none focus:ring-2 focus:ring-[#427A76]">
              @for (status of taskStatuses; track status) {
                <option [ngValue]="status">{{ translateStatus(status) }}</option>
              }
            </select>
          </div>

          <div class="space-y-2">
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-600">Fecha l&iacute;mite</label>
            <input type="date"
                   formControlName="dueOn"
                   class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-[#427A76] focus:outline-none focus:ring-2 focus:ring-[#427A76]" />
          </div>
        </div>

        <div class="space-y-2">
          <label class="text-xs font-semibold uppercase tracking-wide text-slate-600">Asignado a</label>
          <select formControlName="assigneeId"
                  class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-[#427A76] focus:outline-none focus:ring-2 focus:ring-[#427A76] disabled:bg-slate-100"
                  [disabled]="!(teamMembers$ | async)?.length">
            <option [ngValue]="null">Sin asignar</option>
            @if (teamMembers$ | async; as members) {
              @for (member of members; track member.userId) {
                <option [ngValue]="member.userId">{{ member.fullName }} ({{ member.email }})</option>
              }
            }
          </select>
        </div>

        <div class="space-y-3" formArrayName="checklist">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-xs font-semibold uppercase tracking-wide text-slate-600">Checklist</p>
              <p class="text-xs text-slate-500">Define pasos opcionales que ayuden a completar la tarea.</p>
            </div>
            <button type="button"
                    class="rounded-lg border border-slate-300 px-3 py-1 text-xs font-semibold text-slate-700 hover:bg-slate-50"
                    (click)="addChecklistItem()">
              Agregar
            </button>
          </div>

          @for (group of checklistControls; track $index; let i = $index) {
            <div class="rounded-xl border border-slate-200 p-3 space-y-2" [formGroupName]="i">
              <div class="flex items-center justify-between">
                <p class="text-xs font-semibold text-slate-500">Paso {{ i + 1 }}</p>
                <button type="button"
                        class="text-xs font-semibold text-rose-600 hover:text-rose-800"
                        (click)="removeChecklistItem(i)">
                  Quitar
                </button>
              </div>
              <input type="text"
                     formControlName="title"
                     class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-[#427A76] focus:outline-none focus:ring-2 focus:ring-[#427A76]"
                     placeholder="Nombre del paso" />
              <textarea formControlName="description"
                        rows="2"
                        class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-[#427A76] focus:outline-none focus:ring-2 focus:ring-[#427A76]"
                        placeholder="Detalle opcional"></textarea>
              <label class="flex items-center gap-2 text-xs font-medium text-slate-600">
                <input type="checkbox" formControlName="completed" class="rounded border-slate-300 text-[#427A76] focus:ring-[#427A76]" />
                Marcar como completado
              </label>
            </div>
          }
        </div>

        <div class="flex items-center justify-end gap-3 border-t border-slate-100 pt-4">
          <button type="button"
                  class="rounded-lg border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50"
                  (click)="closePanel()">
            Cancelar
          </button>
          <button type="submit"
                  class="rounded-lg bg-[#427A76] px-5 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-[#315a57] disabled:opacity-60"
                  [disabled]="isProcessing">
            {{ isProcessing ? 'Creando...' : 'Crear tarea' }}
          </button>
        </div>
      </form>
    </div>
  </div>
}

