<section class="flex-1 flex flex-col gap-6 p-6">

  <header class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
    <div>
      <h1 class="text-2xl font-bold text-slate-900">Mis equipos</h1>
      <p class="mt-1 text-sm text-slate-600">
        Organiza tus squads y mantiene la colaboración fluida.
      </p>
    </div>

    <div class="flex flex-col sm:flex-row gap-3 sm:items-center">
      <button type="button"
              class="flex items-center justify-center gap-2 rounded-lg bg-[#427A76] px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-[#315a57]"
              (click)="openPanel('team')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" /></svg>
        Crear Equipo
      </button>
      <button type="button"
              class="flex items-center justify-center gap-2 rounded-lg border border-slate-300 bg-white px-4 py-2 text-sm font-semibold text-slate-700 shadow-sm transition hover:bg-slate-50"
              (click)="openPanel('join')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10 2a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5A.75.75 0 0 1 10 2Zm3.75 3.75a.75.75 0 0 0-1.06-1.06l-1.062 1.06a.75.75 0 0 0 1.061 1.062L13.75 5.75ZM6.31 5.75A.75.75 0 0 0 5.25 4.69L4.187 5.75a.75.75 0 0 0 1.061 1.062L6.31 5.75Zm9.44 2.04a.75.75 0 0 1 0 1.06l-1.06 1.06a.75.75 0 1 1-1.06-1.06l1.06-1.06a.75.75 0 0 1 1.06 0ZM3.75 8.81a.75.75 0 0 1 1.06 0l1.06 1.06a.75.75 0 0 1-1.06 1.06l-1.06-1.06a.75.75 0 0 1 0-1.06Zm8.25 8.25a.75.75 0 0 0-1.06-1.06l-1.062 1.06a.75.75 0 0 0 1.061 1.062L12 17.06Zm-6.31 0a.75.75 0 0 0 1.06 1.062l-1.062-1.06a.75.75 0 0 0-1.061 1.062L5.69 17.06Zm-.75-6.31a.75.75 0 0 1 0-1.06l1.06-1.06a.75.75 0 1 1 1.06 1.06l-1.06 1.06a.75.75 0 0 1-1.06 0Zm12 1.06a.75.75 0 0 0-1.06 0l-1.06 1.06a.75.75 0 1 0 1.06 1.06l1.06-1.06a.75.75 0 0 0 0-1.06ZM10 6a4 4 0 1 0 0 8a4 4 0 0 0 0-8Z" /></svg>
        Unirme con Código
      </button>
    </div>
  </header>

  @if (feedback) {
    <div class="rounded-xl border p-4 text-sm"
         [ngClass]="feedback.type === 'success' ? 'border-emerald-200 bg-emerald-50 text-emerald-700' : 'border-rose-200 bg-rose-50 text-rose-700'">
      {{ feedback?.text }}
    </div>
  }

  @if (state$ | async; as state) {
    <div class="mt-4 w-full">
      @switch (state.status) {
        @case ('idle') {
          <div class="max-w-lg rounded-2xl border border-slate-200 bg-white px-8 py-10 text-slate-700 shadow-sm">
            <p class="mb-6 max-w-md text-sm">
              Inicia sesión para sincronizar los equipos asignados a tu usuario.
            </p>
            <button type="button" (click)="openLoginModal()"
                    class="rounded-lg bg-slate-900 px-5 py-2 text-sm font-semibold text-white transition hover:bg-slate-800">
              Iniciar sesion
            </button>
          </div>
        }
        @case ('loading') {
          <div class="grid max-w-5xl grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
            @for (s of [0,1,2]; track s) {
              <div class="h-64 rounded-xl bg-slate-100 animate-pulse"></div>
            }
          </div>
        }
        @case ('error') {
          <div class="max-w-lg rounded-2xl border border-rose-200 bg-rose-50 px-6 py-4 text-sm text-rose-700">
            {{ state.error }}
          </div>
        }
        @case ('ready') {
          <div class="w-full">
            @if (state.teams.length > 0) {
              <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-3">

                @for (teamView of state.teams; track teamView.team.id) {
                  <article class="flex flex-col overflow-hidden rounded-xl border border-slate-200 bg-white shadow-lg transition-all duration-300 hover:shadow-xl border-t-4 border-t-[#427A76]">

                    <div class="flex items-center gap-4 p-5">
                      <div class="grid h-12 w-12 flex-shrink-0 place-items-center rounded-full bg-slate-800 text-lg font-semibold text-white">
                        {{ teamView.team.name.slice(0,2).toUpperCase() }}
                      </div>
                      <div>
                        <h2 class="text-lg font-bold text-slate-900">{{ teamView.team.name }}</h2>
                        <span class="text-xs text-slate-500">Creado el {{ teamView.team.createdAt | date:'mediumDate' }}</span>
                      </div>
                    </div>

                    <div class="px-5 pb-4">
                      <label class="text-xs font-semibold uppercase text-slate-500" for="code-{{teamView.team.id}}">Código para unirse</label>
                      <div class="mt-1 flex items-stretch gap-2">
                        <input id="code-{{teamView.team.id}}" type="text" readonly [value]="teamView.team.code"
                               class="flex-1 rounded-lg border border-slate-300 bg-slate-100 px-3 py-2 font-mono text-sm text-slate-700 focus:outline-none">
                        <button type="button" title="Copiar código"
                                (click)="copyToClipboard(teamView.team.code)"
                                class="flex-shrink-0 rounded-lg border border-slate-300 bg-white px-3 py-2 text-slate-500 transition hover:bg-slate-50 hover:text-slate-800">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M7 3.5A1.5 1.5 0 0 1 8.5 2h3.879a1.5 1.5 0 0 1 1.06.44l3.122 3.121a1.5 1.5 0 0 1 .44 1.06V16.5A1.5 1.5 0 0 1 15.5 18H8.5A1.5 1.5 0 0 1 7 16.5v-13Z" /><path d="M5 6.5A1.5 1.5 0 0 0 3.5 8v8.5A1.5 1.5 0 0 0 5 18h5.5a.75.75 0 0 0 0-1.5H5a.75.75 0 0 1-.75-.75V8A.75.75 0 0 1 5 7.25a.75.75 0 0 0-1.5-.75A1.5 1.5 0 0 0 5 6.5Z" /></svg>
                        </button>
                      </div>
                    </div>

                    <div class="flex-grow rounded-t-xl bg-slate-50 p-5">
                      <p class="text-xs font-semibold uppercase text-slate-500 mb-3">Miembros:</p>

                      <div class="flex items-start justify-between gap-3">
                        @if (teamView.members.length) {
                          <div class="flex flex-wrap gap-2">
                            @for (member of teamView.members.slice(0, 5); track $index) {
                              <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-slate-300 text-xs font-semibold text-slate-700"
                                    [title]="member.fullName">
                                {{ member.initials }}
                              </span>
                            }
                            @if (teamView.members.length > 5) {
                              <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-slate-800 text-xs font-semibold text-white">
                                +{{ teamView.members.length - 5 }}
                              </span>
                            }
                          </div>
                        } @else {
                          <span class="text-xs text-slate-400">Sin miembros</span>
                        }

                        <button type="button"
                                class="inline-flex h-8 w-8 flex-shrink-0 items-center justify-center rounded-full border border-slate-200 text-slate-600 transition hover:bg-white"
                                (click)="toggleTeamMembers(teamView.team.id)"
                                [attr.aria-expanded]="isTeamExpanded(teamView.team.id)">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                               class="h-4 w-4 transition-transform duration-200"
                               [class.rotate-180]="isTeamExpanded(teamView.team.id)" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 0 1 1.06.02L10 10.168l3.71-2.938a.75.75 0 1 1 .94 1.172l-4.2 3.333a.75.75 0 0 1-.94 0l-4.2-3.333a.75.75 0 0 1 .02-1.06Z" clip-rule="evenodd" />
                          </svg>
                        </button>
                      </div>

                      @if (isTeamExpanded(teamView.team.id)) {
                        <div class="mt-3 border-t border-slate-200 pt-3" [attr.id]="'team-members-' + teamView.team.id">
                          @if (!teamView.members.length) {
                            <p class="text-sm text-slate-500">Aun no hay miembros en este equipo.</p>
                          }
                          @if (teamView.members.length) {
                            <ul class="space-y-2 text-sm">
                              @for (member of teamView.members; track $index) {
                                <li class="flex items-center gap-2 text-slate-700">
                                  <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-slate-300 text-[11px] font-semibold text-slate-700">
                                    {{ member.initials }}
                                  </span>
                                  <span class="font-medium text-slate-900">{{ member.fullName }}</span>
                                </li>
                              }
                            </ul>
                          }
                        </div>
                      }
                    </div>

                    <div class="flex items-center justify-between p-5 mt-auto border-t border-slate-100">
                      <span class="text-xs font-semibold uppercase tracking-wider text-sky-700">Equipo activo</span>
                      <a routerLink="/tareas"
                         class="inline-flex items-center rounded-lg bg-[#427A76] px-4 py-2 text-xs font-semibold text-white shadow-sm transition hover:bg-[#315a57]">
                        Ver tareas
                      </a>
                    </div>
                  </article>
                }
              </div>
            } @else {
              <div class="mt-6 max-w-lg rounded-2xl border border-dashed border-slate-300 bg-white px-8 py-12 text-slate-700 shadow-sm">
                <p class="max-w-md text-sm">
                  Aun no perteneces a ningun equipo. Usa los botones "Crear Equipo" o "Unirme a Equipo" para empezar.
                </p>
              </div>
            }
          </div>
        }
      }
    </div>
  }
</section>

@if (activePanel === 'team') {
  <div class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/40 backdrop-blur-sm">
    <div class="relative w-full max-w-md rounded-2xl bg-white p-6 shadow-xl">
      <button type="button" class="absolute right-4 top-4 text-xs font-semibold uppercase text-slate-400 hover:text-slate-600"
              (click)="closePanel()">Cerrar</button>
      <h3 class="text-lg font-semibold text-slate-900">Crear equipo</h3>
      <form [formGroup]="createTeamForm" (ngSubmit)="submitCreateTeam()" class="mt-4 flex flex-col gap-4">
        <label class="flex flex-col gap-1 text-sm text-slate-700">
          Nombre del equipo
          <input type="text" formControlName="name"
                 class="rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-800 focus:border-slate-500 focus:outline-none" />
        </label>
        <button type="submit" [disabled]="isProcessing"
                class="rounded-lg bg-slate-900 px-4 py-2 text-sm font-semibold text-white transition hover:bg-slate-800 disabled:opacity-50">
          {{ isProcessing ? 'Creando...' : 'Crear equipo' }}
        </button>
        @if (feedback?.type === 'error') {
          <div class="rounded-lg border border-rose-200 bg-rose-50 px-3 py-2 text-xs text-rose-700">
            {{ feedback?.text }}
          </div>
        }
      </form>
    </div>
  </div>
}

@if (activePanel === 'join') {
  <div class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/40 backdrop-blur-sm">
    <div class="relative w-full max-w-md rounded-2xl bg-white p-6 shadow-xl">
      <button type="button" class="absolute right-4 top-4 text-xs font-semibold uppercase text-slate-400 hover:text-slate-600"
              (click)="closePanel()">Cerrar</button>
      <h3 class="text-lg font-semibold text-slate-900">Unirme a un equipo</h3>
      <form [formGroup]="joinTeamForm" (ngSubmit)="submitJoinTeam()" class="mt-4 flex flex-col gap-4">
        <label class="flex flex-col gap-1 text-sm text-slate-700">
          Codigo del equipo
          <input type="text" formControlName="code" maxlength="6"
                 class="uppercase rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-800 focus:border-slate-500 focus:outline-none"
                 placeholder="ABC123" />
        </label>
        <button type="submit" [disabled]="isProcessing"
                class="rounded-lg bg-slate-900 px-4 py-2 text-sm font-semibold text-white transition hover:bg-slate-800 disabled:opacity-50">
          {{ isProcessing ? 'Uniendo...' : 'Unirme al equipo' }}
        </button>
        @if (feedback?.type === 'error') {
          <div class="rounded-lg border border-rose-200 bg-rose-50 px-3 py-2 text-xs text-rose-700">
            {{ feedback?.text }}
          </div>
        }
      </form>
    </div>
  </div>
}
